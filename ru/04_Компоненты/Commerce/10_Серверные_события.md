# Серверные события

Commerce устанавливает на сайт дополнительные события, которые можно перехватывать с помощью плагинов, и тем самым добавлять свою логику в процессы магазина.

В основном в событиях используется передача параметров по ссылке, т.е. чтобы изменить что-то, не нужно возвращать результат - достаточно изменить значение параметра. Небольшой пример:

```php
switch ($modx->event->name) {
    case 'OnBeforeCartItemAdding': {
        $params['item']['price'] += 100;
        break;
    }
}
```

Здесь видно два важных момента:
* Используется именно `$modx->event->name` вместо сложившейся практики сохранения ссылки на `$modx->Event`, так как Commerce активно использует вложенные события (http://modx.im/blog/docs/5933.html).
* Изменяется именно элемент массива `$params`, а не переменная `$item`, так как ссылка есть только в массиве.

## Описание событий

#### OnInitializeCommerce

Старт инициализации основного плагина. Параметров нет.

Может использоваться для регистрации клиентских скриптов, которые зависят от Commerce, для регистрации дополнительных корзин, хранилищ, добавления элементов в контейнер зависимостей и пр.

```php
switch ($modx->event->name) {
    case 'OnInitializeCommerce': {
        ci()->set('myCustomClass', function($ci) use ($params) {
            require_once MODX_BASE_PATH . 'path/to/CustomClass.php';
            return new CustomClass($params);
        });

        $modx->regClientScript('path/to/custom-commerce-script.js');
        break;
    }
}
```

#### OnInitializeOrderProcessor

Вызывается в момент получения обработчика заказов. Можно зарегистрировать свой обработчик. Параметров нет.

```php
class CustomOrdersProcessor implements \Commerce\Interfaces\Processor {
    ...
}

switch ($modx->event->name) {
    case 'OnInitializeOrderProcessor': {
        $processor = new CustomOrdersProcessor($modx);
        $modx->commerce->setProcessor($processor);
        break;
    }
}
```

#### OnCollectSubtotals

Вызывается в разные моменты работы пакета для получения массива дополнительных сборов заказа. Сюда можно включить, например, выбранный покупателем способ доставки и ее стоимость, размер скидки или комиссии.

Параметры:
<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>rows</td><td>Да</td><td>
Массив строк, каждая строка представляет собой массив с ключами <code>title</code> и <code>price</code> - название и цена соответственно.
</td></tr>
<tr><td>total</td><td>Да</td><td>Итоговая стоимость заказа</td></tr>
<tr><td>realonly</td><td>Нет</td><td>Принимает значение <code>true</code>, если собираются только элементы, которые реально изменяют стоимость заказа. Это имеет смысл, чтобы не сохранять с заказом сугубо информативные элементы.</td></tr>
</table>

```php
switch ($modx->event->name) {
    case 'OnCollectSubtotals': {
        $params['total'] += 100;
        $params['rows']['fee'] = [
            'title' => 'Комиссия магазина',
            'price' => 100,
        ];
        break;
    }
}
```
Чтобы выводить дополнительный сбор только после перехода покупателя к оформлению заказа, можно использовать метод обработчика заказов `isOrderStarted()`:
```php
if ($modx->commerce->loadProcessor()->isOrderStarted()) {
    // добавляем стоимость доставки
}
```
Если вывод также зависит от выбранного способа доставки или оплаты, можно использовать методы обработчика `getCurrentDelivery()` и `getCurrentPayment()`:
```php
$processor = $modx->commerce->loadProcessor();
if ($processor->getCurrentDelivery() == 'mydelivery' && $processor->getCurrentPayment() == 'mypayment') {
    // добавляем стоимость доставки
}
```


#### OnRegisterDelivery

Сбор всех доступных покупателю способов доставки заказа.

Параметры:
<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>rows</td><td>Да</td><td>
	<p>Массив строк <code><псевдоним></code> => <code><параметры></code>, где <code><псевдоним></code> это символьный идентификатор способа доставки, а <code><параметры></code> - это массив со следующими ключами:</p>
	<table width="100%">
	<tr><td><code>title</code></td><td>название способа доставки</td></tr>
	<tr><td><code>price</code></td><td>стоимость</td></tr>
	<tr><td><code>markup</code></td><td>дополнительный html-код</td></tr>
	</table>
</td></tr>
</table>

```php
switch ($modx->event->name) {
    case 'OnRegisterDelivery': {
        $params['rows']['mydelivery'] = [
            'title' => 'Доставка',
            'price' => 100,
        ];
        break;
    }
}
```

#### OnRegisterPayments

Сбор всех доступных покупателю способов оплаты. Параметров нет.

```php
class CustomPayment implements \Commerce\Interfaces\Payment {
    ...
}

switch ($modx->event->name) {
    case 'OnRegisterPayments': {
        $class = new CustomPayment($modx, $params);
        $modx->commerce->registerPayment('mypayment', 'Мой способ платежа', $class);
        break;
    }
}
```

#### OnCommerceAjaxResponse

Вызывается перед отправкой ответа сервера при ajax-запросе, например при добавлении в корзину или обновлении корзин. Позволяет модифицировать ответ.

Параметры:

<table style="width: 100%;">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>response</td><td>Да</td><td>Массив элементов, из которых состоит ответ сервера.<br>Ключ <code>status</code> есть в любом случае, он может принимать значения <code>success</code> или <code>failed</code> и означает, успешен ли запрос или нет. Остальные элементы в разных запросах различаются.</td></tr>
</table>

```php
switch ($modx->event->name) {
    case 'OnCommerceAjaxResponse': {
        $url = trim($_GET['q'], '/');
        if ($url == 'commerce/action' && $_POST['action'] == 'cart/add') {
            $params['response']['myparam'] = 'myresponse';
        }
    }
}
```

#### OnBeforeCartItemAdding

Вызывается перед добавлением товара в корзину. Позволяет отменить действие, либо модифицировать атрибуты добавляемого товара.

Параметры:
<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>instance</td><td>Нет</td><td>Тип корзины</td></tr>
<tr><td>prevent</td><td>Да</td><td>Флаг отмены действия. Если переключить в <code>true</code>, товар не будет добавлен.</td></tr>
<tr><td>item</td><td>Да</td><td>Массив, описывающий добавляемый товар. Элементы следующие:
	<table width="100%">
		<tr><td><code>id</code></td><td>Идентификатор товара</td></tr>
		<tr><td><code>name</code></td><td>Название</td></tr>
		<tr><td><code>count</code></td><td>Количество</td></tr>
		<tr><td><code>price</code></td><td>Цена одной единицы товара</td></tr>
		<tr><td><code>options</code></td><td>Массив дополнительных опций</td></tr>
		<tr><td><code>meta</code></td><td>Массив дополнительных данных</td></tr>
	</table>
</td></tr>
</table>

```php
switch ($modx->event->name) {
    case 'OnBeforeCartItemAdding': {
        if ($params['item']['price'] < 100) {
            $params['prevent'] = true;
            $modx->event->stopPropagation();
        }
        break;
    }
}
```

#### OnBeforeCartItemUpdating

Вызывается перед изменением товара в корзине. Позволяет модифицировать изменяемые атрибуты.

Параметры:
<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>instance</td><td>Нет</td><td>Тип корзины</td></tr>
<tr><td>row</td><td>Нет</td><td>Уникальный идентификатор строки в корзине</td></tr>
<tr><td>attributes</td><td>Да</td><td>Массив изменяемых атрибутов</td></tr>
</table>

#### OnOrderRawDataChanged
#### OnBeforeOrderProcessing
#### OnBeforePaymentProcess
#### OnBeforeOrderSaving
#### OnBeforeOrderSending
#### OnOrderSaved
#### OnOrderProcessed
#### OnBeforeCurrencyChange
#### OnOrderPlaceholdersPopulated
#### OnBeforeOrderHistoryUpdate
#### OnBeforeCustomerNotifySending
#### OnManagerBeforeOrdersListRender
#### OnManagerOrdersListRender
#### OnManagerBeforeOrderRender
#### OnManagerOrderRender
#### OnManagerBeforeOrderEditRender
#### OnManagerBeforeOrderValidating
#### OnManagerOrderValidated
#### OnManagerStatusesListRender
#### OnManagerStatusRender
#### OnManagerCurrencyListRender
#### OnManagerCurrencyRender
#### OnManagerBeforeDefaultCurrencyChange
#### OnManagerRegisterCommerceController


<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td></tr>
</table>

