# Серверные события

Commerce устанавливает на сайт дополнительные события, которые можно перехватывать с помощью плагинов, и тем самым добавлять свою логику в процессы магазина.

В основном в событиях используется передача параметров по ссылке, т.е. чтобы изменить что-то, не нужно возвращать результат - достаточно изменить значение параметра. Небольшой пример:

```php
switch ($modx->event->name) {
    case 'OnBeforeCartItemAdding': {
        $params['item']['price'] += 100;
        break;
    }
}
```

Здесь видно два важных момента:
* Используется именно `$modx->event->name` вместо сложившейся практики сохранения ссылки на `$modx->Event`, так как Commerce активно использует вложенные события (http://modx.im/blog/docs/5933.html).
* Изменяется именно элемент массива `$params`, а не переменная `$item`, так как ссылка есть только в массиве.

## Описание событий

#### OnInitializeCommerce

Старт инициализации основного плагина. Параметров нет.

Может использоваться для регистрации клиентских скриптов, которые зависят от Commerce, для регистрации дополнительных корзин, хранилищ, добавления элементов в контейнер зависимостей и пр.

```php
switch ($modx->event->name) {
    case 'OnInitializeCommerce': {
        ci()->set('myCustomClass', function($ci) use ($params) {
            require_once MODX_BASE_PATH . 'path/to/CustomClass.php';
            return new CustomClass($params);
        });

        $modx->regClientScript('path/to/custom-commerce-script.js');
        break;
    }
}
```

#### OnInitializeOrderProcessor

Вызывается в момент получения обработчика заказов. Можно зарегистрировать свой обработчик. Параметров нет.

```php
class CustomOrdersProcessor implements \Commerce\Interfaces\Processor {
    ...
}

switch ($modx->event->name) {
    case 'OnInitializeOrderProcessor': {
        $processor = new CustomOrdersProcessor($modx);
        $modx->commerce->setProcessor($processor);
        break;
    }
}
```

#### OnCollectSubtotals

Вызывается в разные моменты работы пакеты для получения массива дополнительных сборов заказа. Сюда можно включить, например, выбранный покупателем способ доставки и ее стоимость, размер скидки или комиссии.

Параметры:
<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>rows</td><td>Да</td><td>
Массив строк, каждая строка представляет собой массив с ключами <code>title</code> и <code>price</code> - название и цена соответственно.
</td></tr>
<tr><td>total</td><td>Да</td><td>Итоговая стоимость заказа</td></tr>
<tr><td>realonly</td><td>Нет</td><td>Принимает значение <code>true</code>, если собираются только элементы, которые реально изменяют стоимость заказа. Это имеет смысл, чтобы не сохранять с заказом сугубо информативные элементы.</td></tr>
</table>

```php
switch ($modx->event->name) {
    case 'OnCollectSubtotals': {
        $params['total'] += 100;
        $params['rows']['fee'] = [
            'title' => 'Комиссия магазина',
            'price' => 100,
        ];
        break;
    }
}
```

#### OnRegisterDelivery

Сбор всех доступных покупателю способов доставки заказа.

Параметры:
<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>rows</td><td>Да</td><td>
Массив строк, каждая строка представляет собой массив с ключами <code>title</code> и <code>price</code> - название и цена соответственно.
</td></tr>
</table>

```php
switch ($modx->event->name) {
    case 'OnRegisterDelivery': {
        $params['rows']['mydelivery'] = [
            'title' => 'Доставка',
            'price' => 100,
        ];
        break;
    }
}
```

#### OnRegisterPayments

Сбор всех доступных покупателю способов оплаты. Параметров нет.

```php
class CustomPayment implements \Commerce\Interfaces\Payment {
    ...
}

switch ($modx->event->name) {
    case 'OnRegisterPayments': {
        $class = new CustomPayment($modx, $params);
        $modx->commerce->registerPayment('mypayment', 'Мой способ платежа', $class);
        break;
    }
}
```

#### OnCommerceAjaxResponse

Вызывается перед отправкой ответа сервера при ajax-запросе, например при добавлении в корзину или обновлении корзин. Позволяет модифицировать ответ.

Параметры:

<table style="width: 100%;">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td>response</td><td>Да</td><td>Массив элементов, из которых состоит ответ сервера</td></tr>
</table>

```php
switch ($modx->event->name) {
    case 'OnCommerceAjaxResponse': {
		$url = trim($_GET['q'], '/');
		
		if ($url == 'commerce/action' && $_POST['action'] == 'cart/add') {
            $params['response']['myparam'] = 'myresponse';
        }
    }
}
```

#### OnBeforeCartItemAdding
#### OnBeforeCartItemUpdating
#### OnOrderRawDataChanged
#### OnBeforeOrderProcessing
#### OnBeforePaymentProcess
#### OnBeforeOrderSaving
#### OnBeforeOrderSending
#### OnOrderSaved
#### OnOrderProcessed
#### OnBeforeCurrencyChange
#### OnOrderPlaceholdersPopulated
#### OnBeforeOrderHistoryUpdate
#### OnBeforeCustomerNotifySending
#### OnManagerBeforeOrdersListRender
#### OnManagerOrdersListRender
#### OnManagerBeforeOrderRender
#### OnManagerOrderRender
#### OnManagerBeforeOrderEditRender
#### OnManagerBeforeOrderValidating
#### OnManagerOrderValidated
#### OnManagerStatusesListRender
#### OnManagerStatusRender
#### OnManagerCurrencyListRender
#### OnManagerCurrencyRender
#### OnManagerBeforeDefaultCurrencyChange
#### OnManagerRegisterCommerceController


<table width="100%">
<tr><th>Имя параметра</th><th>Передается по ссылке</th><th>Описание</th></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td></tr>
</table>

